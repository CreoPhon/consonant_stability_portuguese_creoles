---
title: "Supplementary materials for: Consonant stability in Portuguese-based creoles"
author: "Carlos Silva and Steven Moran"
date: "(`r format(Sys.time(), '%d %B, %Y')`)"
output:
  github_document:
    toc: true
bibliography: 'bibliography.bib'
---
  
# Overview
  
Supplementary materials for [Consonant Stability in Portuguese-based creoles](https://www.overleaf.com/project/60cdac0dd5871295e0f608fc). Silva, Carlos and Steven Moran. Work in progress.

In this report, we use R [@R] and the following packages [@tidyverse;@knitr].

```{r, message=FALSE}
library(tidyverse)
library(knitr)
```

First load the dataset.

```{r, message=FALSE}
database <- read_csv('https://raw.githubusercontent.com/CreoPhon/CreoPhonPt/main/Creoles.csv?token=AAIGDLU6EGPIBXYP3ITSDGDBVCSA6')
```

The data look like this.

```{r}
database %>% head() %>% kable()
```

# Creole stability

Which creoles in the sample are more or less stable overall?

First, we prepare the data for analysis.

```{r}
CreoleStability <- database %>% select(Language, Area, PlaceStability, MannerStability)
CreoleStability$PlaceStability = as.numeric(CreoleStability$PlaceStability)
CreoleStability$MannerStability = as.numeric(CreoleStability$MannerStability)
```

Next, we calculate the stability measure for each creole.

```{r}
GlobalCreoleStability <- mutate(CreoleStability, GlobalStability = (PlaceStability + MannerStability)/2)

final_results <- GlobalCreoleStability %>% group_by(Language, Area) %>% summarize(m = mean(GlobalStability, na.rm = TRUE))
```

Lastly, we plot the results.

```{r}
ggplot(final_results) + 
  geom_bar(aes(x = m, y = reorder(Language, m), fill = Area), 
           stat = "identity", show.legend = FALSE) +
  theme(axis.title.y = element_blank()) +
  labs(x = "Stability score")
```

We have the overall stability values. What are these in relation to the duration of contact?

We can get the length of contact from CreoPhonPT.

```{r, message=FALSE}
cp <- database

tmp <- cp %>% select(Language, `EndOfInfluence`, `FirstMajorSettlement`) %>% distinct()
tmp$duration <- tmp$`EndOfInfluence` - tmp$`FirstMajorSettlement`

tmp <- left_join(tmp, final_results, by=c("Language"))
```

Duration in years.

```{r}
tmp <- tmp %>% rename(MeanStability = m)
tmp %>% select(Language, duration, `FirstMajorSettlement`, `EndOfInfluence`, MeanStability) %>% arrange(desc(duration)) %>% kable()
```

There does not seem to be a relationship between overall duration and overall stability.

```{r}
ggplot(tmp, aes(x=duration, y=MeanStability)) +
  geom_point()

ggplot(tmp, aes(x=duration, y=MeanStability)) +
  geom_point() +
  geom_text(label=tmp$Language)
```
```{r}
msd <- lm(MeanStability ~ duration, data=tmp)
summary(msd)
```

However, there does seem to be two groups of languages -- ones that belong to "long duration" (>= 400 years) and those that belonw to "short duration" (<= 200 years) (Nicholas Lester, pc).

We can try to split the data and rerun the models, but we note that there are very few data points.

```{r}
tmp <- tmp %>% mutate(duration_group = ifelse(duration <= 200, 'short', 'long'))
tmp_short <- tmp %>% filter(duration <= 200)
tmp_long <- tmp %>% filter(duration > 200)
```

```{r}
ggplot(tmp_short, aes(x=duration, y=MeanStability)) +
  geom_point()

ggplot(tmp_short, aes(x=duration, y=MeanStability)) +
  geom_point() +
  geom_text(label=tmp_short$Language)
```

```{r}
ggplot(tmp_long, aes(x=duration, y=MeanStability)) +
  geom_point()

ggplot(tmp_long, aes(x=duration, y=MeanStability)) +
  geom_point() +
  geom_text(label=tmp_long$Language)
```
Or perhaps a single model with an interaction term MeanSim ~ duration, group * duration.

```{r}
msd <- lm(MeanStability ~ duration + duration_group * duration, data=tmp)
summary(msd)

ggplot(tmp, aes(x = duration, y = MeanStability, color = duration_group)) +
  geom_smooth(method = "lm") +
  geom_point()
```

Nicholas Lester notes: The variability in the two groups is very different. The direction of the effect is interesting: shorter durations yield more stability more consistently. Over time, the variability in mean stability increases. Time is "destabillizing the pattern of stability".

And we can also increase the number of observations by running the analysis at the segment level, rather than on mean stability. Here we use the format from the GlobalCreoleStability object for modeling that is created below.


# Segment stability

Which segments are the most stable across creoles in the language sample?

First we prepare the data.

```{r}
data_by_phoneme <- database %>% select(LexifierPhoneme, PlaceStability, MannerStability)
data_by_phoneme$PlaceStability = as.numeric(data_by_phoneme$PlaceStability)
data_by_phoneme$MannerStability = as.numeric(data_by_phoneme$MannerStability)
```

Then we calculate stability of place and manner for each phoneme.

```{r}
place_results <- data_by_phoneme %>% group_by(LexifierPhoneme) %>% summarize(mplace = mean(PlaceStability, na.rm = TRUE))

manner_results <- data_by_phoneme %>% group_by(LexifierPhoneme) %>% summarize(mmanner = mean(MannerStability, na.rm = TRUE))

consonant_stability <- left_join(place_results, manner_results, by = "LexifierPhoneme")

class <- c("nasal", "rhotic", "lateral", "fricative", "stop", "stop", "fricative", "stop", "stop", "lateral", "nasal", "nasal", "stop", "rhotic", "fricative", "stop", "affricate", "fricative", "fricative")

consonant_stability_class <- cbind(consonant_stability, class)
```

Next, we plot the results.

```{r}
# TODO: fix the class "dots"
ggplot(consonant_stability, aes(y = mmanner, x = mplace, label = LexifierPhoneme, color=class)) +
  geom_point(position= "dodge") + 
  geom_text(aes(label=LexifierPhoneme), hjust=3, vjust=0) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
```


Here is an alternative view for the global results.

```{r}
consonant_global_stability <- mutate(consonant_stability_class, mglobal = (mmanner + mplace)/2)

ggplot(consonant_global_stability) + 
  geom_bar(aes(x = mglobal, 
               y = reorder(LexifierPhoneme, mglobal),
               fill = class), stat = "identity", show.legend = TRUE) +
  labs(x = "Stability score", y = "Phoneme", fill = "Manner")
```

# Word position

Next we ask, does word position influence stability?

First, data prepartion.

```{r}
data_by_position <- database %>% select(Position, LexifierPhoneme, PlaceStability, MannerStability) %>% mutate(Position = tolower(Position))

data_by_position$PlaceStability <- as.numeric(data_by_position$PlaceStability)

data_by_position$MannerStability <- as.numeric(data_by_position$MannerStability)
```

Next, calculate stability for each segment according to its word position.

```{r}
position_stability <- mutate(data_by_position, GlobalStability = (PlaceStability + MannerStability)/2)

position_results <- position_stability %>% group_by(LexifierPhoneme, Position) %>% summarize(m = mean(GlobalStability, na.rm = TRUE))
```

And plot the results for all segments.

```{r}
position_results$Position <- factor(position_results$Position, levels = c('word-initial', 'word-medial', 'word-final'))

ggplot(position_results, aes(x = LexifierPhoneme, y = m, fill = Position)) + 
  geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
```

Flip horizontally.

```{r}
ggplot(position_results) + 
  geom_bar(aes(x = m,
               y = reorder(LexifierPhoneme, m),
               fill = Position), 
           stat = "identity", 
           show.legend = TRUE,
           position = "dodge2") +
  labs(x = "Stability score", y = "Phoneme", fill = "Position")
```

Plot the results for segments that show differences.

```{r}
# TODO: update what we show, flip horizontally, change colors
position_results1 <- position_results %>% pivot_wider(names_from = Position, values_from = m)

different_position <- subset(position_results1, position_results1$`word-initial` != position_results1$`word-medial` | position_results1$`word-final` != position_results1$`word-medial`)

different_position_results <- different_position %>% pivot_longer(c(`word-initial`, `word-medial`, `word-final`), names_to = "Position", values_to = "m")

different_position_results$Position <- factor(different_position_results$Position, levels = c('word-initial', 'word-medial', 'word-final'))

ggplot(different_position_results, 
       aes(x = LexifierPhoneme, y = m, fill = Position)) + 
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))
```

Flip horizontally.

```{r}
# TODO: reorder doesn't work here
ggplot(different_position_results) + 
  geom_bar(aes(x = m,
               y = reorder(LexifierPhoneme, m),
               fill = Position), 
           stat = "identity", 
           show.legend = TRUE,
           position = "dodge2") +
  labs(x = "Stability score", y = "Phoneme", fill = "Position")
```

# References
